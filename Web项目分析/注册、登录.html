<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>美多商城-day2</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">.wmd-input, .wmd-input:focus, #md-section-helper {font-family: 16 !important;}
#wmd-preview {font-family: 16 !important;}

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="uv9p" id="美多商城-day2">美多商城-day2</h1><p data-anchor-id="5e21"><code>django-29</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="b8el" id="01知识点复习">01_知识点复习</h2><div class="md-section-divider"></div><h2 data-anchor-id="soos" id="03接口设计思路">03_接口设计思路</h2><ul data-anchor-id="38cu">
<li><p>思路</p>

<ol><li>把一个业务拆分成多个子业务</li>
<li>分析多个子业务之间的关系(先后关系、数据依赖关系)</li>
<li>设计单个子业务对应接口的输入和输出</li></ol></li>
<li><p>设计</p>

<ul><li>请求 <br>
<ol><li>请求方式 <br>
rest 增删改查</li>
<li>url路径 <br>
代表资源</li>
<li>请求参数数据 <br>
url/query_param/header/body(form/json) ?</li></ol></li>
<li>响应 <br>
一般只考虑正常的 <br>
结果及格式</li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="mc0y" id="04图片验证码接口设计">04_图片验证码接口设计</h2><ul data-anchor-id="9cx6">
<li><p>注册业务</p>

<ul><li>常见</li>
<li>一个业务功能 5个接口 <br>
<ol><li>获得验证码</li>
<li>发送校验短信</li>
<li>校验用户名重复</li>
<li>校验手机号重复</li>
<li>注册功能</li></ol></li></ul></li>
<li><p>图片验证码</p>

<ul><li><p>分析</p>

<ul><li>请求 <br>
<ol><li>get的请求方式</li>
<li>url : /image_codes/<code>&lt;image_code_id&gt;</code>/ </li></ol></li>
<li>响应 <br>
返回图片</li></ul></li>
<li><p>实现思路</p>

<ol><li>定义视图类继承于APIView <br>
不需要到数据库和序列化器</li>
<li>实现get方法 <br>
<ol><li>生成图片</li>
<li>保存真实值(为的是后面校验)</li>
<li>返回图片给前端</li></ol></li>
<li>配置url <br>
<code>url(r'image_codes/(?P&lt;image_code_id&gt;[\w-]+)/$', views.ImageCodeView.as_view()),</code></li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="1jt0" id="05图片验证码后端接口实现">05_图片验证码后端接口实现</h2><ul data-anchor-id="s1rv">
<li><p>步骤</p>

<ol><li>创建应用，并注册</li>
<li>导入captcha到libs中</li>
<li>完成视图代码 <br>
<ol><li>使用captcha生成图片和真实值</li>
<li>使用redis记录真实值，存到名为verify_codes的缓存中(需要添加缓存)</li>
<li>返回HttpResponse 内容是 图片， 类型是 image/jpg</li></ol></li>
<li>配置url</li></ol></li>
<li><p>代码实现</p>

<ol><li><p>创建应用 <br>
    <code>cd meiduo_mall/meiduo_mall/apps/ <br>
    django-admin startapp verifications</code></p></li>
<li><p>注册应用</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">INSTALLED_APPS </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">'verifications.apps.VerificationsConfig'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>编写视图类</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> django_redis </span><span class="kwd">import</span><span class="pln"> get_redis_connection</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">http</span><span class="pun">.</span><span class="pln">response </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">HttpResponse</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">views </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">APIView</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="kwd">from</span><span class="pln"> meiduo_mall</span><span class="pun">.</span><span class="pln">libs</span><span class="pun">.</span><span class="pln">captcha</span><span class="pun">.</span><span class="pln">captcha </span><span class="kwd">import</span><span class="pln"> captcha</span></code></li><li class="L5"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> </span><span class="kwd">import</span><span class="pln"> constants</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">ImageCodeView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L9"><code><span class="str">    图片验证码</span></code></li><li class="L0"><code><span class="str">    """</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 请求时需要添加图片id</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> image_code_id</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 生成验证码图片 ,获取随机文本和对应图片</span></code></li><li class="L4"><code><span class="pln">        text</span><span class="pun">,</span><span class="pln"> image </span><span class="pun">=</span><span class="pln"> captcha</span><span class="pun">.</span><span class="pln">generate_captcha</span><span class="pun">()</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 获取redis的连接对象 , 需要在配置文件中配置名为verify_codes的redis缓存</span></code></li><li class="L7"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">"verify_codes"</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 存入redis数据库，便于后面的业务进行校验</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 并指定过期时间 自动删除</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 与视频相比，这里简化了常量的定义</span></code></li><li class="L1"><code><span class="pln">        redis_conn</span><span class="pun">.</span><span class="pln">setex</span><span class="pun">(</span><span class="str">"img_%s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> image_code_id</span><span class="pun">,</span><span class="lit">300</span><span class="pun">,</span><span class="pln"> text</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 返回http响应 注意指定内容类型为image/jpg 表示图片</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 虽然我们使用的是APIView，但也可以返回 django中的 HttpResponse  drf 框架会做判断</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">HttpResponse</span><span class="pun">(</span><span class="pln">image</span><span class="pun">,</span><span class="pln"> content_type</span><span class="pun">=</span><span class="str">"image/jpg"</span><span class="pun">)</span></code></li><li class="L6"><code></code></li></ol></pre></li>
<li><p>配置视图类的url</p>

<ul><li><p>应用的</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf</span><span class="pun">.</span><span class="pln">urls </span><span class="kwd">import</span><span class="pln"> url</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> </span><span class="kwd">import</span><span class="pln"> views</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L4"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'image_codes/(?P&lt;image_code_id&gt;[\w-]+)/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">ImageCodeView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L5"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>项目的</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L2"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^'</span><span class="pln"> </span><span class="pun">,</span><span class="pln"> include</span><span class="pun">(</span><span class="str">'verifications.urls'</span><span class="pun">))</span></code></li><li class="L3"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="q9c2" id="06关于序列化器抛出异常的说明">06_关于序列化器抛出异常的说明</h2><p data-anchor-id="xsa1">异常的工作原理： <br>
抛出后会随着方法调用栈一层一层抛出，直到被捕获处理</p><div class="md-section-divider"></div><h2 data-anchor-id="bhsc" id="07前后端本地域名设置">07_前后端本地域名设置</h2><ul data-anchor-id="dv34">
<li><p>域名 dns 与 hosts <br>
域名是人易于记忆的内容，用于标识一个网站 <br>
ip 这是计算机在进行数据传输时使用到 <br>
域名到ip的转化过程有两种方式</p>

<ol><li>查询dns服务器 </li>
<li>本地hosts文件 <br>
其中优先查询本机hosts文件，没找到再查dns服务器</li></ol></li>
<li><p>hosts文件</p>

<ul><li>位置 <br>
<ul><li>linux/mac <br>
<code>/etc/hosts</code></li>
<li>windows <br>
<code>C:\Windows\System32\drivers\etc\hosts</code></li></ul></li>
<li>重要性 <br>
因为涉及到域名解析过程，所以如果被恶意程序篡改，可能上一个假网站，所以修改需要管理员权限</li>
<li>格式 <br>
一行一个映射关系 <br>
ip  空白 域名</li></ul></li>
<li><p>使用域名访问程序</p>

<ol><li><p>修改hosts文件(添加如下内容)</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 被#注释掉的不会起作用</span></code></li><li class="L1"><code><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">   api</span><span class="pun">.</span><span class="pln">meiduo</span><span class="pun">.</span><span class="pln">site</span></code></li><li class="L2"><code><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln">   www</span><span class="pun">.</span><span class="pln">meiduo</span><span class="pun">.</span><span class="pln">site</span></code></li></ol></pre></li>
<li><p>访问</p>

<ul><li>live-server <br>
<a href="http://www.meiduo.site:8080/" target="_blank">http://www.meiduo.site:8080/</a></li>
<li>django <br>
<a href="http://api.meiduo.site:8000/" target="_blank">http://api.meiduo.site:8000/</a></li></ul></li></ol></li>
<li><p>前端 <br>
避免修改域名带来的多处修改问题，可以在一个地方记录域名，其他地方直接使用即可</p>

<ol><li><p>添加host.js</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">var</span><span class="pln"> host </span><span class="pun">=</span><span class="pln"> </span><span class="str">"http://api.meiduo.site:8000"</span><span class="pln"> </span></code></li></ol></pre></li>
<li><p>在html中引入常量js文件 <br>
<code>&lt;scirpt src='js/host.js'&gt;&lt;/script&gt;</code></p></li>
<li>在其他js中使用常量 <br>
并修改对应使用地址的地方</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="9os7" id="08图片验证码前端实现">08_图片验证码前端实现</h2><ul data-anchor-id="yvwh">
<li><p>准备工作</p>

<ol><li><p>报错：缺少相应库 <br>
<code>pip install Pillow</code></p></li>
<li><p>测试</p>

<ol><li>测试显示效果</li>
<li>测试后端存储</li></ol></li></ol></li>
<li><p>思路 <br>
刚才写的是后端，现在写前端 <br>
因为已经设计好了，现在需要结合前后端 <br>
前端就是请求数据、显示数据</p></li>
<li><p>显示验证码图片</p>

<ul><li><p>js <br>
register.js</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">var</span><span class="pln"> vm </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Vue</span><span class="pun">({</span></code></li><li class="L1"><code><span class="pln">    el</span><span class="pun">:</span><span class="pln"> </span><span class="str">'#app'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    data</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        host</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">        image_code_id</span><span class="pun">:</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">        image_code_url</span><span class="pun">:</span><span class="pln"> </span><span class="str">''</span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">},</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 生命周期方法</span></code></li><li class="L8"><code><span class="pln">    mounted</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(){</span></code></li><li class="L9"><code><span class="pln">        get_image_code</span><span class="pun">();</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">},</span></code></li><li class="L1"><code><span class="pln">    methods</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">        get_image_code</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(){</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com">// 每次调用获得不同的uuid</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">image_code_id </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">generate_uuid</span><span class="pun">();</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">image_code_url </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">host </span><span class="pun">+</span><span class="str">"image_codes/"</span><span class="pun">+</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">image_code_id</span><span class="pun">+</span><span class="str">"/"</span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        generate_uuid</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(){</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com">// 略</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">},</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pun">});</span></code></li></ol></pre></li>
<li><p>html</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="com">&lt;!-- &lt;img :src="images/pic_code.jpg" alt="图形验证码" class="pic_code"&gt;--&gt;</span></code></li><li class="L1"><code><span class="tag">&lt;img</span><span class="pln"> :</span><span class="atn">src</span><span class="pun">=</span><span class="atv">"image_code_url"</span><span class="pln"> @</span><span class="atn">click</span><span class="pun">=</span><span class="atv">"get_image_code"</span><span class="pln"> </span><span class="atn">alt</span><span class="pun">=</span><span class="atv">"图形验证码"</span><span class="pln"> </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"pic_code"</span><span class="tag">&gt;</span></code></li></ol></pre></li>
<li><p>urls.py <br>
注意因为使用了uuid格式，所以匹配的正则不再是[\w-]+ 而是 [0-9a-fA-F-]+</p></li></ul></li>
<li><p>复习</p>

<ul><li>vue的使用 <br>
<ol><li>el</li>
<li>:</li>
<li>@</li>
<li>生命周期</li></ol></li>
<li><p>使用axios获取数据</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">axios</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"http://127.0.0.1:8000/image_codes/"</span><span class="pun">+</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">image_code_id</span><span class="pun">+</span><span class="str">"/"</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">.</span><span class="kwd">then</span><span class="pun">(</span><span class="pln">response </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln">         </span><span class="pun">})</span><span class="pln">  </span><span class="com">// 正常处理 响应码为 2xx</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">.</span><span class="kwd">catch</span><span class="pun">(</span><span class="pln">error </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln">           </span><span class="pun">})</span><span class="pln">  </span><span class="com">// 处理异常 响应码为 4xx 5xx</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="p2fz" id="09短信验证码后端接口设计">09_短信验证码后端接口设计</h2><ul data-anchor-id="q3tf">
<li><p>发送短信验证码的业务流程</p>

<ul><li>前端 <br>
用户输入手机号 图形验证码 点击获取验证码 <br>
代码中需要检查手机号格式，再发送</li>
<li>后端 <br>
检查手机号格式(冗余)、检查验证码是否正确(需要前端传递验证码图片id) <br>
再发送验证码</li>
<li>业务问题 <br>
<ol><li>能否前端校验图形验证码是否正确后再要求后端给手机号发送验证码 <br>
不行， 两次请求，可以伪造(绕过验证码校验)</li>
<li>为什么获取短信验证码要 图形验证码 并且有一定的间隔时间 <br>
因为 发送手机短信要收费</li></ol></li></ul></li>
<li><p>设计</p>

<ul><li>请求:GET /sms_codes/{mobile}/?image_code_id=xxx&amp;text=xxx</li>
<li>响应 返回一个成功与否，及失败的原因</li></ul></li>
<li><p>实现思路</p>

<ol><li>定义类继承于GenericAPIView <br>
需要需要用到序列化器对象</li>
<li>实现get方法 <br>
<ol><li>校验数据(交给序列化器对象完成)</li>
<li>生成短信验证码</li>
<li>保存短信验证码和发送记录</li>
<li>发送短信验证码</li>
<li>返回响应</li></ol></li>
<li>定义序列化类ImageCodeCheckSerialzier继承于Serialzier <br>
因为不涉及到使用模型</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ixw8" id="10发送短信验证码序列化器实现">10_发送短信验证码序列化器实现</h2><ul data-anchor-id="52hz">
<li><p>代码实现</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework </span><span class="kwd">import</span><span class="pln"> serializers</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django_redis </span><span class="kwd">import</span><span class="pln"> get_redis_connection</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> redis</span><span class="pun">.</span><span class="pln">exceptions </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">RedisError</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">ImageCodeCheckSerialzier</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L6"><code><span class="str">    图片验证码校验序列化器</span></code></li><li class="L7"><code><span class="str">    GenericAPIView  -&gt;  get_seriliazer()  context</span></code></li><li class="L8"><code><span class="str">    """</span></code></li><li class="L9"><code><span class="pln">    </span><span class="com"># 发送的格式是uuid，而且是类似 5ce0e9a5-5ffa-654b-cee0-1238041fb31a 格式的，</span></code></li><li class="L0"><code><span class="pln">    </span><span class="com"># 定义UUIDField如果不传递选项，默认就是hex_verbose，也就是符合我们指定的格式的</span></code></li><li class="L1"><code><span class="pln">    image_code_id </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">UUIDField</span><span class="pun">()</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 4位随机字符串</span></code></li><li class="L3"><code><span class="pln">    text </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">min_length</span><span class="pun">=</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> max_length</span><span class="pun">=</span><span class="lit">4</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> attrs</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="str">"""校验图片验证码是否正确"""</span></code></li><li class="L7"><code><span class="pln">        image_code_id </span><span class="pun">=</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'image_code_id'</span><span class="pun">]</span></code></li><li class="L8"><code><span class="pln">        text </span><span class="pun">=</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'text'</span><span class="pun">]</span></code></li><li class="L9"><code></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 查询redis数据库，获取真实的验证码</span></code></li><li class="L2"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 从redis中获取正确的图形验证码对应的字符串</span></code></li><li class="L4"><code><span class="pln">        real_image_code </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'img_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> image_code_id</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> real_image_code </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">            </span><span class="com"># 过期或者前端胡编乱造的image_code_id</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'无效的图片验证码'</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 对比</span></code></li><li class="L1"><code><span class="pln">         </span><span class="com"># 从redis拿到的是 bytes类型，需要转为str类型才能比对</span></code></li><li class="L2"><code><span class="pln">        real_image_code </span><span class="pun">=</span><span class="pln"> real_image_code</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L3"><code><span class="pln">         </span><span class="com"># 不区分大小写</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> real_image_code</span><span class="pun">.</span><span class="pln">lower</span><span class="pun">()</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> text</span><span class="pun">.</span><span class="pln">lower</span><span class="pun">():</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'图片验证码错误'</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># redis中发送短信验证码的标志 send_flag_&lt;mobile&gt;  : 1, 由redis维护60s的有效期</span></code></li><li class="L8"><code><span class="pln">         </span><span class="com"># 手机号是关键字参数，会被添加到视图对象的 kwargs字典属性中</span></code></li><li class="L9"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">context</span><span class="pun">[</span><span class="str">'view'</span><span class="pun">].</span><span class="pln">kwargs</span><span class="pun">[</span><span class="str">'mobile'</span><span class="pun">]</span></code></li><li class="L0"><code><span class="pln">         </span><span class="com"># 这个地方目前没有对应的保存逻辑</span></code></li><li class="L1"><code><span class="pln">        send_flag </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'send_flag_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> send_flag</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'发送短信次数过于频繁'</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 校验通过返回原始数据</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> attrs</span></code></li></ol></pre></li>
<li><p>疑点(源码)</p>

<ol><li><p>序列化对象如何创建的/context 是从哪里来的</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">GenericAPIView</span><span class="pun">(</span><span class="pln">views</span><span class="pun">.</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 我们在调用这个方法的时候</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 第一个参数传递 直接传，表示模型实例 (如果是序列化 或者 部分更新)</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com"># 后面的第二个参数要传 data= 字典 (如果是反序列化) ，因为request.query_params 和 request.data 就是字典查形式的，所以可以直接传他们</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 其他的可以放 many= True  partial =True</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_serializer</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 获得序列化器类</span></code></li><li class="L7"><code><span class="pln">            serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer_class</span><span class="pun">()</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 获得上下文字典 ，并添加到kwargs中</span></code></li><li class="L9"><code><span class="pln">            kwargs</span><span class="pun">[</span><span class="str">'context'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer_context</span><span class="pun">()</span></code></li><li class="L0"><code><span class="pln">            </span><span class="com"># 创建序列化器对象</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> serializer_class</span><span class="pun">(*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_serializer_class</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 检查是否存在serializer_class属性，没有就抛异常，有就直接返回</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">serializer_class</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_serializer_context</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 返回字典，这是序列化器可能需要的数据</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">            </span><span class="str">'request'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">request</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">            </span><span class="str">'format'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">format_kwarg</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">            </span><span class="str">'view'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span></code></li></ol></pre>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">BaseSerializer</span><span class="pun">(</span><span class="typ">Field</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> instance</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">=</span><span class="pln">empty</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">instance </span><span class="pun">=</span><span class="pln"> instance</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> data </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> empty</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initial_data </span><span class="pun">=</span><span class="pln"> data</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">partial</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> kwargs</span><span class="pun">.</span><span class="pln">pop</span><span class="pun">(</span><span class="str">'partial'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">_context </span><span class="pun">=</span><span class="pln"> kwargs</span><span class="pun">.</span><span class="pln">pop</span><span class="pun">(</span><span class="str">'context'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{})</span></code></li><li class="L7"><code><span class="pln">        kwargs</span><span class="pun">.</span><span class="pln">pop</span><span class="pun">(</span><span class="str">'many'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">(</span><span class="typ">BaseSerializer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">).</span><span class="pln">__init__</span><span class="pun">(**</span><span class="pln">kwargs</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">Serializer</span><span class="pun">(</span><span class="typ">BaseSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 没有定义 __init__ 方法</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">pass</span></code></li><li class="L3"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">ModelSerializer</span><span class="pun">(</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 没有定义 __init__ 方法</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">pass</span></code></li><li class="L6"><code></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">Field</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">   </span><span class="lit">@property</span></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> root</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">        root </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> root</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="lit">@property</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> context</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> getattr</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">root</span><span class="pun">,</span><span class="pln"> </span><span class="str">'_context'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{})</span></code></li></ol></pre></li>
<li><p>视图对象的 kwargs是什么 ，从哪来 <br>
是调用视图函数中的关键字参数(url路径中的捕获的内容)</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">APIView</span><span class="pun">(</span><span class="typ">View</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@classmethod</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> as_view</span><span class="pun">(</span><span class="pln">cls</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">initkwargs</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 调用 django中的 View的 as_view 得到函数</span></code></li><li class="L4"><code><span class="pln">        view </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">super</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">,</span><span class="pln"> cls</span><span class="pun">).</span><span class="pln">as_view</span><span class="pun">(**</span><span class="pln">initkwargs</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> csrf_exempt</span><span class="pun">(</span><span class="pln">view</span><span class="pun">)</span></code></li></ol></pre>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">View</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@classonlymethod</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> as_view</span><span class="pun">(</span><span class="pln">cls</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">initkwargs</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">def</span><span class="pln"> view</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 每次请求 创建出对象 具体的View对象</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cls</span><span class="pun">(**</span><span class="pln">initkwargs</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 调用具体view对象的 dispatch 方法</span></code></li><li class="L7"><code><span class="pln">            </span><span class="com"># 传递原始的请求，位置参数、关键字参数</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 并返回dispatch的结果</span></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">dispatch</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> view</span></code></li></ol></pre>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">APIView</span><span class="pun">(</span><span class="typ">View</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># args 接受到的位置参数</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># kwargs 接受到的关键字参数</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> dispatch</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 保存到当前视图对象上做属性</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">args </span><span class="pun">=</span><span class="pln"> args</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">kwargs </span><span class="pun">=</span><span class="pln"> kwargs</span></code></li><li class="L7"><code><span class="pln">        request </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initialize_request</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> request</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">...</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="9l37" id="11发送短信验证码视图实现">11_发送短信验证码视图实现</h2><ul data-anchor-id="v7vx">
<li><p>后端校验</p>

<ul><li>前后端分离</li>
<li>前端校验 <br>
<ol><li>用户体验</li>
<li>降低后端压力</li></ol></li>
<li>后端也校验 <br>
<ol><li>避免"高级"用户发送请求</li>
<li>避免恶意用户发送请求</li></ol></li></ul></li>
<li><p>视图的实现</p>

<ol><li>使用序列化器完成校验逻辑</li>
<li>random模块产生随机数字作为短信验证码</li>
<li>手机号做key，短信验证码做value 存入redis</li>
<li>手机号做key，保存发送记录</li>
<li>使用yuntongxun发送短信 <br>
<ol><li>导入云通讯相关代码到utils中</li>
<li>使用CCP对象发送短信</li>
<li>注意添加常量</li></ol></li>
<li>根据发送情况返回响应 <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SMSCodeView</span><span class="pun">(</span><span class="typ">GenericAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    短信验证码</span></code></li><li class="L3"><code><span class="str">    传入参数：</span></code></li><li class="L4"><code><span class="str">        mobile,     image_code_id, text</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ImageCodeCheckSerializer</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> mobile</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 校验参数  由序列化器完成</span></code></li><li class="L0"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 生成短信验证码</span></code></li><li class="L4"><code><span class="pln">        sms_code </span><span class="pun">=</span><span class="pln"> </span><span class="str">'%06d'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> random</span><span class="pun">.</span><span class="pln">randint</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">999999</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 保存短信验证码  保存发送记录</span></code></li><li class="L7"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        redis_conn</span><span class="pun">.</span><span class="pln">setex</span><span class="pun">(</span><span class="str">"sms_%s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">,</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_REDIS_EXPIRES</span><span class="pun">,</span><span class="pln"> sms_code</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        redis_conn</span><span class="pun">.</span><span class="pln">setex</span><span class="pun">(</span><span class="str">"send_flag_%s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">,</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SEND_SMS_CODE_INTERVAL</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 发送短信</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            ccp </span><span class="pun">=</span><span class="pln"> CCP</span><span class="pun">()</span></code></li><li class="L5"><code><span class="pln">            expires </span><span class="pun">=</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_REDIS_EXPIRES </span><span class="com">// 60</span></code></li><li class="L6"><code><span class="pln">            result </span><span class="pun">=</span><span class="pln"> ccp</span><span class="pun">.</span><span class="pln">send_template_sms</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">sms_code</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">],</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_TEMP_ID</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> e</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">            logger</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">"发送验证码短信[异常][ mobile: %s, message: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">))</span></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'failed'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> result </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">                logger</span><span class="pun">.</span><span class="pln">info</span><span class="pun">(</span><span class="str">"发送验证码短信[正常][ mobile: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'OK'</span><span class="pun">})</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">                logger</span><span class="pun">.</span><span class="pln">warning</span><span class="pun">(</span><span class="str">"发送验证码短信[失败][ mobile: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'failed'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="pun">)</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="1yaq" id="12补充redis管道">12_补充redis管道</h2><ul data-anchor-id="21df">
<li><p>redis管道 <br>
通过管道可以 将多个命令一起发送给redis，然后再得到多个执行结果 <br>
优点是：可以显著减少网络交互次数</p></li>
<li><p>代码使用</p>

<ul><li><p>api</p>

<ol><li>pl = strict_redis.pipeline()  <br>
可以得到一个StrictPipeline类型的对象</li>
<li>进行redis操作 <br>
pl对象和 strict_redis一样有各种各样的redis命令，但这些命令并没有执行，所以不能得到结果，但返回pl对象，可以进行链式调用</li>
<li>pl.execute() <br>
让所有的命令进行执行，这个方法得到的结果是个list，里面记录了每个命令的返回值(包括异常)</li></ol></li>
<li><p>例子</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 保存验证码及发送记录</span></code></li><li class="L1"><code><span class="pln">redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln"> </span><span class="com"># 效率较低的做法</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com"># redis_conn.setex('sms_%s' % mobile, constants.SMS_CODE_REDIS_EXPIRES, sms_code)</span></code></li><li class="L5"><code><span class="pln"> </span><span class="com"># redis_conn.setex('send_flag_%s' % mobile, constants.SEND_SMS_CODE_INTERVAL, 1)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln"> </span><span class="com"># 使用redis的pipeline管道一次执行多个命令</span></code></li><li class="L8"><code><span class="pln">pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L9"><code><span class="pln">pl</span><span class="pun">.</span><span class="pln">setex</span><span class="pun">(</span><span class="str">'sms_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">,</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_REDIS_EXPIRES</span><span class="pun">,</span><span class="pln"> sms_code</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">pl</span><span class="pun">.</span><span class="pln">setex</span><span class="pun">(</span><span class="str">'send_flag_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">,</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SEND_SMS_CODE_INTERVAL</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 让管道执行命令</span></code></li><li class="L2"><code><span class="pln">pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="qxzd" id="13补充删除图片验证码的逻辑">13_补充删除图片验证码的逻辑</h2><p data-anchor-id="jgtd">避免重复验证，绕开验证行为发送短信</p><p data-anchor-id="32ho">在序列化器中添加如下代码</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qxtx"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com">#... 获取在redis存储的值</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 删除redis中的图片验证码</span></code></li><li class="L2"><code><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">delete</span><span class="pun">(</span><span class="str">'img_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> image_code_id</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln"> </span><span class="com">#... 进行判断前</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="p5no" id="14发送短信前端代码说明与测试跨域请求">14_发送短信前端代码说明与测试跨域请求</h2><ul data-anchor-id="abjp">
<li><p>基本流程</p>

<ol><li>关联按钮点击事件</li>
<li>点击后 <br>
校验 <br>
    校验手机号是否填写及格式是否正确 <br>
    校验验证码是否填写及格式是否正确 <br>
    如果校验不通过，不继续执行 <br>
业务 <br>
    拼装url <br>
    使用axios发送请求() <br>
        成功 <br>
            进行倒计时显示 <br>
        失败 <br>
            弹出错误信息</li></ol></li>
<li><p>一些细节 <br>
通过sending_flag来标识 点击获取短信验证码是否有效 <br>
在进入点击事件对应的方法中判断sending_flag如果为true则返回 <br>
马上改为true <br>
在发送请求后如果失败了改为false <br>
如果成功了进行完倒计时后改为false</p></li>
<li><p>代码 <br>
略</p></li>
<li><p>调bug的要点 <br>
做一件事需要很多个环节都正确才行，只有有一个环节出错，就不行。 <br>
我们要确定那个环节出了问题。</p>

<ul><li>前端 <br>
<ol><li>看chrome调试工具的network，判断请求有没有发出，响应是什么</li>
<li>看chrome调试工具的console，看出了什么错</li></ol></li>
<li>后端 <br>
<ol><li>看看日志请求是否进来</li>
<li>如果404检查url</li>
<li>代码报错一般看后面几行</li>
<li>找我们的代码</li>
<li>借助print 确认代码执行到了没有</li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="0ljc" id="15cors解决跨域请求">15_CORS解决跨域请求</h2><ul data-anchor-id="jydb">
<li><p>跨域 <br>
域 = 协议 +  域名 + 端口 <br>
跨域 两个域中 其中任意部分不同</p></li>
<li><p>跨域相关</p>

<ul><li><p>浏览器策略 <br>
对于aoixs发送的请求，虽然我们在控制台看到了" Access-Control-Allow-Origin" 字样，但并不是没有发出请求。 <br>
对于简单请求(详情浏览参考资料)，浏览器会发出请求，但得到响应后会校验响应头中是否有当前域，如果没有则会在控制台输出错误，并不会把响应的结果交给js代码 <br>
对于复杂请求(详情浏览参考资料)，浏览器会先发送一个OPTION请求，询问服务器是否支持跨域，如果响应头中表名允许，才会发出对应的请求来获取数据， 并交给js代码</p></li>
<li><p>参考资料 <br>
<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a></p></li>
<li><p>相关头</p>

<ul><li><p>请求</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Request</span><span class="pun">-</span><span class="typ">Method</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L1"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Request</span><span class="pun">-</span><span class="typ">Headers</span><span class="pun">:</span><span class="pln"> </span></code></li></ol></pre></li>
<li><p>响应</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Allow</span><span class="pun">-</span><span class="typ">Origin</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L1"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Allow</span><span class="pun">-</span><span class="typ">Methods</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L2"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Allow</span><span class="pun">-</span><span class="typ">Headers</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L3"><code><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Max</span><span class="pun">-</span><span class="typ">Age</span><span class="pun">:</span><span class="pln"> </span></code></li></ol></pre></li></ul></li></ul></li>
<li><p>跨域资源访问的解决</p>

<ul><li>请求端 <br>
通过前向代理进行处理(在vue中已经使用)</li>
<li>响应端 <br>
<ol><li>通过后向代理解决(nginx经过合适配置后，可以合并为同一个域就不存在跨域了)</li>
<li>服务器配置</li></ol></li></ul></li>
<li><p>django中 对于 跨域资源共享的解决</p>

<ol><li>安装django-cors-headers <br>
<code>pip install django-cors-headers</code> <br>
<ul><li>专用于django </li>
<li>cors=Cross-Origin Resource Sharing</li>
<li>heads 用于处理跨域资源共享的相关http头</li></ul></li>
<li><p>安装应用</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">INSTALLED_APPS </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">'corsheaders'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L4"><code><span class="pun">)</span></code></li></ol></pre></li>
<li><p>配置中间件</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">MIDDLEWARE </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">'corsheaders.middleware.CorsMiddleware'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L3"><code><span class="pun">]</span></code></li></ol></pre>

<p>一定要添加到最前面</p></li>
<li><p>添加白名单</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 这些域会被添加到Access-Control-Allow-Origin头中</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 如果允许所有的，就使用 "*"</span></code></li><li class="L2"><code><span class="pln">CORS_ORIGIN_WHITELIST </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">'127.0.0.1:8080'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">'localhost:8080'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">'www.meiduo.site:8080'</span></code></li><li class="L6"><code><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">CORS_ALLOW_CREDENTIALS </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span><span class="pln">  </span><span class="com"># 允许携带cookie</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="n8tv" id="16认识celery">16_认识Celery</h2><ul data-anchor-id="3c4b">
<li>需求 <br>
在视图函数中 有发送短信逻辑，它本质上是联网请求 <br>
这个联网请求可能比较耗时 <br>
进而导致视图函数执行耗时较长 <br>
进而影响前端用户体验</li>
<li><p>解决 <br>
异步 进行耗时处理</p></li>
<li><p>celery <br>
分布式异步任务队列调度框架，既支持同步也支持异步</p>

<ul><li>概念 <br>
<ul><li>任务 <br>
一些要执行的代码</li>
<li>任务队列 <br>
多个任务</li>
<li>调度 <br>
优先级/指定worker等</li>
<li>分布式 <br>
各个部分可以不在同一个电脑上， 各个部分可以有多个</li>
<li>异步 <br>
不阻塞，不等待结果</li>
<li>同步 <br>
阻塞，等待结果</li></ul></li>
<li>特点 <br>
<ol><li>简单</li>
<li>高性能</li>
<li>灵活</li></ol></li>
<li>图示 <br>
<ol><li> <br>
<img src="http://static.zybuluo.com/jsutqb/v1gsiz87qdjespxi8cuqjxdm/image_1chbcgmgc1tcreq11hfdc4h1em29.png" alt="image_1chbcgmgc1tcreq11hfdc4h1em29.png-399.1kB"></li>
<li> <br>
<img src="http://static.zybuluo.com/jsutqb/j4h6u4b7s1jw081umqe3kgy0/image_1chbch8cuk151bdt1cdf1abb11aam.png" alt="image_1chbch8cuk151bdt1cdf1abb11aam.png-313.5kB"></li></ol></li>
<li>主要构成 <br>
<ol><li>client    任务的发起方</li>
<li>worker    任务的执行方</li>
<li>broker    中间人(client和worker的接头人)</li>
<li>backend   任务执行结果的存储</li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="9bcz" id="17celery目录搭建">17_Celery目录搭建</h2><p data-anchor-id="0dq2">这里省略了配置文件和常量文件(为了简化)</p><ul data-anchor-id="20tl">
<li><p>建立文件/文件夹</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">celery_tasks        </span><span class="pun">放置所有</span><span class="pln">celery</span><span class="pun">任务的包</span></code></li><li class="L1"><code><span class="pun">├──</span><span class="pln"> __init__</span><span class="pun">.</span><span class="pln">py     </span></code></li><li class="L2"><code><span class="pun">├──</span><span class="pln"> main</span><span class="pun">.</span><span class="pln">py         </span><span class="pun">一会启动</span><span class="pln">worker</span><span class="pun">的入口</span></code></li><li class="L3"><code><span class="pun">└──</span><span class="pln"> sms             </span><span class="pun">与发送短信有关的</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">├──</span><span class="pln"> __init__</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">└──</span><span class="pln"> tasks</span><span class="pun">.</span><span class="pln">py    </span><span class="pun">任务函数所在的模块(建议名称为</span><span class="pln">tasks</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>编写代码 </p>

<ul><li><p>main</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 导入Celery类</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> celery </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Celery</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="str">''' 老师的代码使用了外部文件，较复杂</span></code></li><li class="L4"><code><span class="str">celery_app = Celery('</span><span class="pln">meiduo</span><span class="str">')</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="str"># 导入配置文件</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="str">celery_app.config_from_object('</span><span class="pln">celery_tasks</span><span class="pun">.</span><span class="pln">config</span><span class="str">')</span></code></li><li class="L9"><code><span class="str">'''</span></code></li><li class="L0"><code><span class="pln"> </span><span class="com"># 创建出Celery对象，指定名称，并指定broker </span></code></li><li class="L1"><code><span class="pln">celery_app </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Celery</span><span class="pun">(</span><span class="str">'meiduo'</span><span class="pun">,</span><span class="pln">broker</span><span class="pun">=</span><span class="str">"redis://127.0.0.1:6379/15"</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln"> </span><span class="com"># 自动注册celery任务</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com"># 需要指定 所有任务模块所在的包(一个也要用列表)</span></code></li><li class="L5"><code><span class="pln">celery_app</span><span class="pun">.</span><span class="pln">autodiscover_tasks</span><span class="pun">([</span><span class="str">'celery_tasks.sms'</span><span class="pun">])</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="3mcc" id="18发送短信异步任务实现">18_发送短信异步任务实现</h2><ul data-anchor-id="9k86">
<li><p>定义函数</p>

<ul><li>定义函数</li>
<li>复制代码</li>
<li>添加参数</li>
<li>删除掉关于响应的返回值</li></ul>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">utils</span><span class="pun">.</span><span class="pln">yuntongxun</span><span class="pun">.</span><span class="pln">sms </span><span class="kwd">import</span><span class="pln"> CCP</span></code></li><li class="L1"><code><span class="kwd">import</span><span class="pln"> logging</span></code></li><li class="L2"><code><span class="pln">logger </span><span class="pun">=</span><span class="pln"> logging</span><span class="pun">.</span><span class="pln">getLogger</span><span class="pun">(</span><span class="str">'django'</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="kwd">def</span><span class="pln"> send_sms_code</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> sms_code</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">,</span><span class="pln"> temp_id</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">    </span><span class="str">"""发送短信验证码"""</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">        ccp </span><span class="pun">=</span><span class="pln"> CCP</span><span class="pun">()</span></code></li><li class="L8"><code><span class="pln">        result </span><span class="pun">=</span><span class="pln"> ccp</span><span class="pun">.</span><span class="pln">send_template_sms</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">sms_code</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">],</span><span class="pln"> temp_id</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> e</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">        logger</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">"发送验证码短信[异常][ mobile: %s, message: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">))</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> result </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            logger</span><span class="pun">.</span><span class="pln">info</span><span class="pun">(</span><span class="str">"发送验证码短信[正常][ mobile: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            logger</span><span class="pun">.</span><span class="pln">warning</span><span class="pun">(</span><span class="str">"发送验证码短信[失败][ mobile: %s ]"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>在main中准备logger所需要的环境</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 为celery使用django配置文件进行设置</span></code></li><li class="L1"><code><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L2"><code><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">getenv</span><span class="pun">(</span><span class="str">'DJANGO_SETTINGS_MODULE'</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    os</span><span class="pun">.</span><span class="pln">environ</span><span class="pun">[</span><span class="str">'DJANGO_SETTINGS_MODULE'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'meiduo_mall.settings.dev'</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com"># 下面是celery对象的创建</span></code></li></ol></pre></li>
<li><p>变普通函数为任务函数</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> celery_tasks</span><span class="pun">.</span><span class="pln">main </span><span class="kwd">import</span><span class="pln"> celery_app</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="lit">@celery_app</span><span class="pun">.</span><span class="pln">task</span><span class="pun">(</span><span class="pln">name</span><span class="pun">=</span><span class="str">'send_sms_code'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="kwd">def</span><span class="pln"> send_sms_code</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> sms_code</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">,</span><span class="pln"> temp_id</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 略</span></code></li></ol></pre></li>
<li><p>在视图中使用异步任务发送短信</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># # 发送短信</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># try:</span></code></li><li class="L2"><code><span class="pln"> </span><span class="com">#     ccp = CCP()</span></code></li><li class="L3"><code><span class="pln"> </span><span class="com">#     expires = constants.SMS_CODE_REDIS_EXPIRES // 60</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com">#     result = ccp.send_template_sms(mobile, [sms_code, expires], constants.SMS_CODE_TEMP_ID)</span></code></li><li class="L5"><code><span class="pln"> </span><span class="com"># except Exception as e:</span></code></li><li class="L6"><code><span class="pln"> </span><span class="com">#     logger.error("发送验证码短信[异常][ mobile: %s, message: %s ]" % (mobile, e))</span></code></li><li class="L7"><code><span class="pln"> </span><span class="com">#     return Response({'message': 'failed'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)</span></code></li><li class="L8"><code><span class="pln"> </span><span class="com"># else:</span></code></li><li class="L9"><code><span class="pln"> </span><span class="com">#     if result == 0:</span></code></li><li class="L0"><code><span class="pln"> </span><span class="com">#         logger.info("发送验证码短信[正常][ mobile: %s ]" % mobile)</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com">#         return Response({'message': 'OK'})</span></code></li><li class="L2"><code><span class="pln"> </span><span class="com">#     else:</span></code></li><li class="L3"><code><span class="pln"> </span><span class="com">#         logger.warning("发送验证码短信[失败][ mobile: %s ]" % mobile)</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com">#         return Response({'message': 'failed'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln"> </span><span class="com"># 使用celery发送短信验证码</span></code></li><li class="L7"><code><span class="pln">expires </span><span class="pun">=</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_REDIS_EXPIRES </span><span class="com">// 60</span></code></li><li class="L8"><code><span class="pln">send_sms_code</span><span class="pun">.</span><span class="pln">delay</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">,</span><span class="pln"> sms_code</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">,</span><span class="pln"> constants</span><span class="pun">.</span><span class="pln">SMS_CODE_TEMP_ID</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'OK'</span><span class="pun">})</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="rk48" id="19celery运行与测试">19_Celery运行与测试</h2><ol data-anchor-id="uxnr">
<li>开启worker <br>
<code>celery -A celery_tasks.main worker -l info</code></li>
<li><p>开启后端</p></li>
<li><p>前端测试</p>

<ul><li><p>使用步骤</p>

<ol><li>安装celery <br>
<code>pip install celery</code></li>
<li><p>创建出Celery对象(一般称为应用app)</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">app </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Celery</span><span class="pun">()</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 必须指定 broker </span></code></li></ol></pre></li>
<li><p>定义函数(普通python函数)</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> send_sms_code</span><span class="pun">(</span><span class="pln">to</span><span class="pun">,</span><span class="pln">vcode</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">pass</span></code></li></ol></pre></li>
<li><p>使用app.task 装饰该函数，使其成为任务函数</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="lit">@app</span><span class="pun">.</span><span class="pln">task</span></code></li><li class="L1"><code><span class="kwd">def</span><span class="pln"> send_sms_code</span><span class="pun">(</span><span class="pln">to</span><span class="pun">,</span><span class="pln">vcode</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">pass</span></code></li></ol></pre></li>
<li><p>开启worker <br>
<code>celery -A 任务函数的路径 -l info</code></p></li>
<li>client 发布任务 <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">send_sms_code</span><span class="pun">.</span><span class="pln">delay</span><span class="pun">(</span><span class="str">"13812345678"</span><span class="pln"> </span><span class="pun">,</span><span class="str">'1234'</span><span class="pun">)</span></code></li></ol></pre></li></ol></li></ul></li>
</ol><div class="md-section-divider"></div><h2 data-anchor-id="koig" id="20判断帐号是否存在说明">20_判断帐号是否存在说明</h2><p data-anchor-id="dtkj">这些业务实现在users应用中</p><ul data-anchor-id="nwd7">
<li><p>校验用户名是否存在</p>

<ul><li><p>设计 <br>
请求 GET /usernames/<code>用户名</code>/count <br>
响应 {"username":用户名,"count":出现次数}</p></li>
<li><p>实现</p>

<ul><li><p>后端</p>

<ul><li><p>views</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UsernameCountView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> username</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        count </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">username</span><span class="pun">=</span><span class="pln">username</span><span class="pun">).</span><span class="pln">count</span><span class="pun">()</span></code></li><li class="L3"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">            </span><span class="str">'username'</span><span class="pun">:</span><span class="pln"> username</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">            </span><span class="str">'count'</span><span class="pun">:</span><span class="pln"> count</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>urls</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'usernames/(?P&lt;username&gt;\w{5,20})/count/'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">UsernameCountView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li>
<li><p>前端 <br>
check_username 中 用 axios 发送请求 得到响应 如果count &gt; 0 则不通过，反之则通过</p></li></ul></li></ul></li>
<li>校验手机号是否存在 <br>
同上</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="hjpv" id="21注册后端接口实现">21_注册后端接口实现</h2><ul data-anchor-id="3flg">
<li><p>视图 <br>
校验数据 创建对象 返回对象，标准的流程，可以使用 CreateAPIView</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UserView</span><span class="pun">(</span><span class="typ">CreateAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CreateUserSerializer</span></code></li></ol></pre></li>
<li><p>序列化器</p>

<ul><li>序列化器 要考虑如下问题 <br>
<ol><li>进行参数的接受 <br>
<ol><li>相比模型，有多余的字段 (确认密码、同意协议、短信验证码)</li></ol></li>
<li>进行校验 <br>
<ol><li>借助自身的验证规则 <br>
必填 required <br>
类型由 模型保证 <br>
唯一由 模型保证 <br>
合理的长度 指定 元选项的 extra_kwargs</li>
<li>每个字段 <br>
正则 <br>
同意协议</li>
<li>整体校验 <br>
确认密码是否一致，短信验证码是否正确</li></ol></li>
<li>进行数据保存(业务处理) <br>
rest 中create的默认行为是 调用序列化器的save方法 <br>
模型序列化器的save方法会掉模型的模型管理的create方法 <br>
但如果这样 保存的密码就是明文的了 <br>
所以在保存用需要调用 User对象的set_password 方法传入明文密码转为密文密码 <br>
在调用user对象的save方法保存</li>
<li>返回响应 <br>
有些字段不能返回，比如密码，所以要设置外write_only</li></ol></li>
<li>代码 <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CreateUserSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    创建用户序列化器</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    password2 </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'确认密码'</span><span class="pun">,</span><span class="pln"> write_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    sms_code </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'短信验证码'</span><span class="pun">,</span><span class="pln"> write_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    allow </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'同意协议'</span><span class="pun">,</span><span class="pln"> write_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate_mobile</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">        </span><span class="str">"""验证手机号"""</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">match</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^1[345789]\d{9}$'</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'手机号格式错误'</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> value</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate_allow</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="str">"""检验用户是否同意协议"""</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> value </span><span class="pun">!=</span><span class="pln"> </span><span class="str">'true'</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'请同意用户协议'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> value</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 判断两次密码</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'password2'</span><span class="pun">]:</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'两次密码不一致'</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 判断短信验证码</span></code></li><li class="L6"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'mobile'</span><span class="pun">]</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        real_sms_code </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'sms_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> real_sms_code </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'无效的短信验证码'</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'sms_code'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> real_sms_code</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">():</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'短信验证码错误'</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> data</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> create</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L9"><code><span class="str">        创建用户</span></code></li><li class="L0"><code><span class="str">        """</span></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 移除数据库模型类中不存在的属性</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">del</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'password2'</span><span class="pun">]</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">del</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'sms_code'</span><span class="pun">]</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">del</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'allow'</span><span class="pun">]</span></code></li><li class="L5"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">super</span><span class="pun">().</span><span class="pln">create</span><span class="pun">(</span><span class="pln">validated_data</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 调用django的认证系统加密密码</span></code></li><li class="L8"><code><span class="pln">        user</span><span class="pun">.</span><span class="pln">set_password</span><span class="pun">(</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">])</span></code></li><li class="L9"><code><span class="pln">        user</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> user</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span></code></li><li class="L5"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'username'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password2'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'sms_code'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'mobile'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'allow'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        extra_kwargs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">            </span><span class="str">'id'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="str">'read_only'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">},</span></code></li><li class="L8"><code><span class="pln">            </span><span class="str">'username'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">                </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">                </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">                </span><span class="str">'error_messages'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">                    </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许5-20个字符的用户名'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">                    </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许5-20个字符的用户名'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">},</span></code></li><li class="L6"><code><span class="pln">            </span><span class="str">'password'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">                </span><span class="str">'write_only'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">                </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">                </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">                </span><span class="str">'error_messages'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">                    </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许8-20个字符的密码'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">                    </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许8-20个字符的密码'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">                </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">            </span><span class="pun">}</span></code></li></ol></pre></li></ul></li>
<li><p>配置url</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^users/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">UserView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="1952" id="22注册前端代码与测试">22_注册前端代码与测试</h2><ul data-anchor-id="57l8">
<li><p>前端代码</p>

<ul><li>思路 <br>
<ol><li>表单提交事件</li>
<li>校验数据</li>
<li>校验通过后发送请求</li>
<li>接受响应</li>
<li>页面跳转</li></ol></li>
<li>实现 <br>
略</li></ul></li>
<li><p>测试</p>

<ol><li>正常注册，看是否跳转</li>
<li>查看后端数据库</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="w7c5" id="23总结">23_总结</h2><div class="md-section-divider"></div><h2 data-anchor-id="x13d" id="24drf框架知识串讲">24_DRF框架知识串讲</h2></div>
</body>
</html>